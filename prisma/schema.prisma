generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Tenant {
  id              String       @id @default(uuid()) @db.Uuid
  name            String       @db.VarChar(255)
  slug            String       @unique @db.VarChar(100)
  timezone        String       @default("America/Mexico_City") @db.VarChar(50)
  defaultCurrency String       @default("USD") @map("default_currency") @db.VarChar(3)
  planType        String       @default("trial") @map("plan_type") @db.VarChar(20)
  isActive        Boolean      @default(true) @map("is_active")
  createdAt       DateTime     @default(now()) @map("created_at")
  updatedAt       DateTime     @default(now()) @updatedAt @map("updated_at")
  collections     Collection[]
  companies       Company[]
  invoices        Invoice[]
  playbooks       Playbook[]
  users           User[]

  @@map("tenants")
}

model User {
  id          String   @id @default(uuid()) @db.Uuid
  tenantId    String   @map("tenant_id") @db.Uuid
  clerkUserId String   @unique @map("clerk_user_id") @db.VarChar(255)
  email       String   @db.VarChar(255)
  firstName   String   @map("first_name") @db.VarChar(100)
  lastName    String   @map("last_name") @db.VarChar(100)
  role        String   @default("admin") @db.VarChar(20)
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at")
  tenant      Tenant   @relation(fields: [tenantId], references: [id])

  // Playbooks created by this user
  createdPlaybooks Playbook[] @relation("PlaybookCreatedBy")

  @@index([tenantId])
  @@index([clerkUserId])
  @@map("users")
}

model Company {
  id          String       @id @default(uuid()) @db.Uuid
  tenantId    String       @map("tenant_id") @db.Uuid
  name        String       @db.VarChar(255)
  taxId       String       @map("tax_id") @db.VarChar(50)
  phone       String?      @db.VarChar(50)
  address     String?
  industry    String?      @db.VarChar(100)
  riskLevel   String       @default("medio") @map("risk_level") @db.VarChar(20)
  hasPortal   Boolean      @default(false) @map("has_portal")
  isActive    Boolean      @default(true) @map("is_active")
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @default(now()) @updatedAt @map("updated_at")
  tenant      Tenant       @relation(fields: [tenantId], references: [id])
  collections Collection[]
  contacts    Contact[]
  invoices    Invoice[]

  @@unique([tenantId, taxId])
  @@index([tenantId])
  @@map("companies")
}

model Contact {
  id                  String       @id @default(uuid()) @db.Uuid
  tenantId            String       @map("tenant_id") @db.Uuid
  companyId           String       @map("company_id") @db.Uuid
  firstName           String       @map("first_name") @db.VarChar(100)
  lastName            String       @map("last_name") @db.VarChar(100)
  email               String       @db.VarChar(255)
  phone               String?      @db.VarChar(50)
  position            String?      @db.VarChar(100)
  isPrimaryContact    Boolean      @default(false) @map("is_primary_contact")
  isEscalationContact Boolean      @default(false) @map("is_escalation_contact")
  isActive            Boolean      @default(true) @map("is_active")
  createdAt           DateTime     @default(now()) @map("created_at")
  updatedAt           DateTime     @default(now()) @updatedAt @map("updated_at")
  company             Company      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  collections         Collection[] @relation("CollectionPrimaryContact")

  @@index([tenantId])
  @@index([companyId])
  @@map("contacts")
}

model Invoice {
  id                    String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId              String       @map("tenant_id") @db.Uuid
  companyId             String       @map("company_id") @db.Uuid
  invoiceNumber         String       @map("invoice_number") @db.VarChar(100)
  amount                Decimal      @db.Decimal(15, 2)
  currency              String       @default("USD") @db.VarChar(3)
  issueDate             DateTime     @map("issue_date") @db.Date
  dueDate               DateTime     @map("due_date") @db.Date
  paymentTermsDays      Int          @default(30) @map("payment_terms_days")
  projectedPaymentDate  DateTime?    @map("projected_payment_date") @db.Date
  confirmedPaymentDate  DateTime?    @map("confirmed_payment_date") @db.Date
  paidDate              DateTime?    @map("paid_date") @db.Date
  paymentStatus         String       @default("pendiente") @map("payment_status") @db.VarChar(50)
  paymentReference      String?      @map("payment_reference") @db.VarChar(255)
  description           String?
  notes                 String?
  isActive              Boolean      @default(true) @map("is_active")
  createdAt             DateTime     @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt             DateTime     @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  collections           Collection[]
  company               Company      @relation(fields: [companyId], references: [id])
  tenant                Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, invoiceNumber], name: "invoices_tenant_id_invoice_number_key")
  @@index([tenantId, paymentStatus])
  @@index([tenantId, dueDate])
  @@index([companyId])
  @@map("invoices")
}

model Playbook {
  id              String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId        String            @map("tenant_id") @db.Uuid
  name            String            @db.VarChar(255)
  description     String?           @db.Text
  triggerType     String            @map("trigger_type") @db.VarChar(20)
  triggerDays     Int?              @map("trigger_days")
  isActive        Boolean           @default(true) @map("is_active")
  isDefault       Boolean           @default(false) @map("is_default")
  createdByUserId String?           @map("created_by_user_id") @db.Uuid
  createdAt       DateTime          @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime          @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  collections     Collection[]
  messages        PlaybookMessage[]
  tenant          Tenant            @relation(fields: [tenantId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  createdBy       User?             @relation("PlaybookCreatedBy", fields: [createdByUserId], references: [id])

  // NOTE: Partial unique index for is_default=true is defined in SQL migration
  // See: prisma/migrations/rls-policies-playbooks.sql
  // This ensures only ONE default playbook per trigger_type per tenant
  @@index([tenantId])
  @@map("playbooks")
}

model PlaybookMessage {
  id                   String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  playbookId           String   @map("playbook_id") @db.Uuid
  sequenceOrder        Int      @map("sequence_order")
  channel              String   @db.VarChar(20)
  temperature          String   @db.VarChar(20)
  subjectTemplate      String?  @map("subject_template")
  bodyTemplate         String   @map("body_template")
  useAiGeneration      Boolean  @default(false) @map("use_ai_generation")
  aiInstructions       String?  @map("ai_instructions")
  waitDays             Int      @default(0) @map("wait_days")
  sendOnlyIfNoResponse Boolean  @default(true) @map("send_only_if_no_response")
  createdAt            DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt            DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  playbook             Playbook @relation(fields: [playbookId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([playbookId, sequenceOrder])
  @@index([playbookId])
  @@map("playbook_messages")
}

model Collection {
  id                  String    @id @default(uuid()) @db.Uuid
  tenantId            String    @map("tenant_id") @db.Uuid
  invoiceId           String    @map("invoice_id") @db.Uuid
  companyId           String    @map("company_id") @db.Uuid
  primaryContactId    String    @map("primary_contact_id") @db.Uuid
  playbookId          String    @map("playbook_id") @db.Uuid
  currentMessageIndex Int       @default(0) @map("current_message_index")
  status              String    @default("active") @db.VarChar(30)
  messagesSentCount   Int       @default(0) @map("messages_sent_count")
  lastMessageSentAt   DateTime? @map("last_message_sent_at") @db.Timestamptz(6)
  customerResponded   Boolean   @default(false) @map("customer_responded")
  lastResponseAt      DateTime? @map("last_response_at") @db.Timestamptz(6)
  startedAt           DateTime  @default(now()) @map("started_at") @db.Timestamptz(6)
  nextActionAt        DateTime? @map("next_action_at") @db.Timestamptz(6)
  completedAt         DateTime? @map("completed_at") @db.Timestamptz(6)
  createdAt           DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt           DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  tenant         Tenant   @relation(fields: [tenantId], references: [id])
  invoice        Invoice  @relation(fields: [invoiceId], references: [id])
  company        Company  @relation(fields: [companyId], references: [id])
  primaryContact Contact  @relation("CollectionPrimaryContact", fields: [primaryContactId], references: [id])
  playbook       Playbook @relation(fields: [playbookId], references: [id])

  // NOTE: Partial unique index for active collections is defined in SQL migration
  // See: prisma/migrations/rls-policies-collections.sql
  // This ensures only ONE non-terminal collection per invoice
  @@index([tenantId], name: "collections_tenant_id_idx")
  @@index([tenantId, status], name: "collections_tenant_status_idx")
  @@index([status, nextActionAt], name: "collections_status_next_action_idx")
  @@map("collections")
}

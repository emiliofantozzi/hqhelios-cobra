// prisma/schema.prisma

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

generator client {
  provider = "prisma-client-js"
}

model Tenant {
  id              String   @id @default(uuid()) @db.Uuid
  name            String   @db.VarChar(255)
  slug            String   @unique @db.VarChar(100)
  timezone        String   @default("America/Mexico_City") @db.VarChar(50)
  defaultCurrency String   @default("USD") @map("default_currency") @db.VarChar(3)
  planType        String   @default("trial") @map("plan_type") @db.VarChar(20)
  isActive        Boolean  @default(true) @map("is_active")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @default(now()) @updatedAt @map("updated_at")

  users     User[]
  companies Company[]
  invoices  Invoice[]

  @@map("tenants")
}

model User {
  id          String   @id @default(uuid()) @db.Uuid
  tenantId    String   @map("tenant_id") @db.Uuid
  clerkUserId String   @unique @map("clerk_user_id") @db.VarChar(255)
  email       String   @db.VarChar(255)
  firstName   String   @map("first_name") @db.VarChar(100)
  lastName    String   @map("last_name") @db.VarChar(100)
  role        String   @default("admin") @db.VarChar(20)
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at")

  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@index([tenantId])
  @@index([clerkUserId])
  @@map("users")
}

model Company {
  id               String   @id @default(uuid()) @db.Uuid
  tenantId         String   @map("tenant_id") @db.Uuid
  name             String   @db.VarChar(255)
  taxId            String   @map("tax_id") @db.VarChar(50)
  email            String?  @db.VarChar(255)
  phone            String?  @db.VarChar(50)
  address          String?  @db.Text
  industry         String?  @db.VarChar(100)
  paymentTermsDays Int      @default(30) @map("payment_terms_days")
  riskLevel        String   @default("medio") @map("risk_level") @db.VarChar(20)
  isActive         Boolean  @default(true) @map("is_active")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @default(now()) @updatedAt @map("updated_at")

  tenant   Tenant    @relation(fields: [tenantId], references: [id])
  contacts Contact[]
  invoices Invoice[]

  @@unique([tenantId, taxId])
  @@index([tenantId])
  @@map("companies")
}

model Contact {
  id                  String   @id @default(uuid()) @db.Uuid
  tenantId            String   @map("tenant_id") @db.Uuid
  companyId           String   @map("company_id") @db.Uuid
  firstName           String   @map("first_name") @db.VarChar(100)
  lastName            String   @map("last_name") @db.VarChar(100)
  email               String   @db.VarChar(255)
  phone               String?  @db.VarChar(50)
  position            String?  @db.VarChar(100)
  isPrimaryContact    Boolean  @default(false) @map("is_primary_contact")
  isEscalationContact Boolean  @default(false) @map("is_escalation_contact")
  isActive            Boolean  @default(true) @map("is_active")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @default(now()) @updatedAt @map("updated_at")

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([companyId])
  @@map("contacts")
}

model Invoice {
  id                   String    @id @default(uuid()) @db.Uuid
  tenantId             String    @map("tenant_id") @db.Uuid
  companyId            String    @map("company_id") @db.Uuid
  invoiceNumber        String    @map("invoice_number") @db.VarChar(100)
  amount               Decimal   @db.Decimal(15, 2)
  currency             String    @default("USD") @db.VarChar(3)
  issueDate            DateTime  @map("issue_date") @db.Date
  dueDate              DateTime  @map("due_date") @db.Date
  confirmedPaymentDate DateTime? @map("confirmed_payment_date") @db.Date
  paidDate             DateTime? @map("paid_date") @db.Date
  paymentStatus        String    @default("pendiente") @map("payment_status") @db.VarChar(50)
  paymentReference     String?   @map("payment_reference") @db.VarChar(255)
  description          String?   @db.Text
  notes                String?   @db.Text
  isActive             Boolean   @default(true) @map("is_active")
  createdAt            DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt            DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  company Company @relation(fields: [companyId], references: [id], onDelete: Restrict)

  @@unique([tenantId, invoiceNumber], name: "invoices_tenant_id_invoice_number_key")
  @@index([tenantId, paymentStatus], name: "invoices_tenant_id_payment_status_idx")
  @@index([tenantId, dueDate], name: "invoices_tenant_id_due_date_idx")
  @@index([companyId], name: "invoices_company_id_idx")
  @@map("invoices")
}

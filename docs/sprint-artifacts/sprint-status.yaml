# generated: 2025-12-01
# project: cobra-bmad
# project_key: cobra-bmad
# tracking_system: file-system
# story_location: '{project-root}/docs/sprint-artifacts'

# STATUS DEFINITIONS:
# ==================
# Epic Status:
#   - backlog: Epic exists in epic file but not contexted
#   - contexted: Epic tech context created (required before drafting stories)
#
# Story Status:
#   - backlog: Story only exists in epic file
#   - drafted: Story file created in stories folder by *create-story
#   - ready-for-dev: Draft approved and story context created by *story-ready
#   - in-progress: Developer actively working on implementation by *dev-story
#   - review: Implementation complete, ready for review by *code-review
#   - done: Story completed by *story-done
#
# Retrospective Status:
#   - optional: Can be completed but not required
#   - completed: Retrospective has been done by *retrospective
#
# WORKFLOW NOTES:
# ===============
# - Epics should be marked `contexted` before stories can be marked beyond `backlog`
# - SM typically drafts next story ONLY after previous one is 'done' to incorporate learnings
# - Dev moves story to 'review', SM reviews, then Dev moves to 'done'

generated: 2025-12-03
project: cobra-bmad
project_key: cobra-bmad
tracking_system: file-system
story_location: '{project-root}/docs/sprint-artifacts'

development_status:
  # ============================================================
  # Epic 1: Foundation Setup
  # ============================================================
  epic-1: contexted
  1-1-configurar-supabase-con-rls-multi-tenant: done
  1-2-integrar-clerk-con-custom-claims: done
  1-3-auto-registro-con-creacion-de-tenant: done
  1-4-seed-data-de-tenant-demo: done
  epic-1-retrospective: done

  # ============================================================
  # Epic 2: CRM y Gestión de Clientes
  # ============================================================
  epic-2: done
  2-1-crear-empresas-cliente: done
  2-2-listar-y-editar-empresas: done
  2-3-gestionar-contactos-de-empresa: done
  2-4-editar-y-desactivar-contactos: done
  2-5-crear-facturas-manualmente: done
  2-6-gestionar-estados-de-facturas: done
  2-7-importar-facturas-desde-csv: done
  2-8-dashboard-basico-con-kpis: done
  2-9-exportar-datos-a-csv: done
  epic-2-retrospective: done

  # ============================================================
  # Epic 3: Motor de Cobranzas Automatizado
  # ============================================================
  # Party Mode Session: 2025-12-03
  # Gaps Resolved: C1 (IMessageService), C2 (State Machine), C3 (Rate Limiting)
  # Risk Mitigated: R-001 (Upstash Redis lock)
  epic-3: contexted
  3-1-schema-de-playbooks-y-mensajes: done
  3-2-builder-de-playbooks: done
  3-3-playbooks-pre-configurados-seed: done
  3-4-schema-de-collections: ready-for-dev
  3-5-crear-cobranza-desde-factura: backlog
  3-6-worker-de-procesamiento-automatico: backlog
  3-7-control-manual-de-cobranzas: backlog
  epic-3-retrospective: optional

  # ============================================================
  # Epic 4: Comunicación Multicanal
  # ============================================================
  epic-4: backlog
  4-1-envio-de-emails-transaccionales: backlog
  4-2-envio-de-whatsapp: backlog
  4-3-historial-de-mensajes-enviados: backlog
  4-4-webhooks-de-delivery-status: backlog
  epic-4-retrospective: optional

  # ============================================================
  # Epic 5: Loop de Respuestas e IA
  # ============================================================
  epic-5: backlog
  5-1-captura-de-respuestas-email-n8n: backlog
  5-2-captura-de-respuestas-whatsapp-n8n: backlog
  5-3-endpoint-de-customer-response: backlog
  5-4-bandeja-de-respuestas-pendientes: backlog
  5-5-aprobar-sugerencia-de-ia: backlog
  5-6-accion-manual-override: backlog
  5-7-panel-de-contexto-completo: backlog
  epic-5-retrospective: optional

  # ============================================================
  # Epic 6: Dashboard Operativo y Analytics
  # ============================================================
  epic-6: backlog
  6-1-dashboard-operativo-completo: backlog
  6-2-exportacion-de-reportes: backlog
  6-3-notificaciones-in-app: backlog
  6-4-notificaciones-por-email: backlog
  6-5-escalamiento-manual: backlog
  epic-6-retrospective: optional

# ============================================================
# EPIC 2 DETAILED SPRINT PLANNING
# ============================================================
# Generated: 2025-12-02
# Status: Ready for Phase 4 (Development)
# Total Stories: 9
# Implementation Readiness: Approved by Architect

epic_2_detailed_plan:
  epic_id: "epic-2"
  epic_name: "CRM y Gestión de Clientes"
  phase: "Phase 4 - Implementation COMPLETE"
  status: "done"
  total_stories: 9
  completed_stories: 9

  # ============================================================
  # CRITICAL STORY SEQUENCE
  # ============================================================
  # Stories MUST be executed in this order to respect dependencies
  # Each layer depends on completion of previous layer

  story_sequence:
    foundation_layer:
      # MUST execute first - creates empresas table/UI
      - "2.1"

    dependency_layer_1:
      # Depends on 2.1 (empresas must exist)
      - "2.3"

    core_functionality:
      # Depends on 2.1 (empresas) and 2.3 (contactos)
      - "2.5"

    state_management:
      # Depends on 2.5 (invoices must exist for state transitions)
      - "2.6"

    parallel_features:
      # Can execute concurrently after 2.6 is complete
      # All depend on foundation being ready
      - "2.2"  # Edit empresas (needs 2.1 + 2.6 state management)
      - "2.4"  # Edit contactos (needs 2.3 + 2.6 state management)
      - "2.7"  # CSV import (needs 2.1, 2.5, 2.6)
      - "2.9"  # CSV export (needs 2.1, 2.3, 2.5)

    final_integration:
      # Dashboard runs last - depends on all data being available
      - "2.8"

  # ============================================================
  # STORY DETAILS
  # ============================================================

  stories:
    - id: "2.1"
      title: "Crear Empresas Cliente"
      status: "done"
      priority: "critical"
      dependencies: []
      blocks: ["2.2", "2.3", "2.4", "2.5", "2.7", "2.9"]
      estimated_points: 5
      acceptance_criteria_count: 8
      notes: "Foundation story - MUST execute first"

    - id: "2.2"
      title: "Listar y Editar Empresas"
      status: "done"
      priority: "high"
      dependencies: ["2.1", "2.6"]
      blocks: []
      estimated_points: 3
      acceptance_criteria_count: 7
      notes: "Can run in parallel with 2.4, 2.7, 2.9 after 2.6 is done"

    - id: "2.3"
      title: "Gestionar Contactos de Empresa"
      status: "done"
      priority: "critical"
      dependencies: ["2.1"]
      blocks: ["2.4", "2.5", "2.7", "2.9"]
      estimated_points: 5
      acceptance_criteria_count: 9
      notes: "Execute immediately after 2.1"

    - id: "2.4"
      title: "Editar y Desactivar Contactos"
      status: "done"
      priority: "high"
      dependencies: ["2.3", "2.6"]
      blocks: []
      estimated_points: 3
      acceptance_criteria_count: 6
      notes: "Can run in parallel with 2.2, 2.7, 2.9 after 2.6 is done"

    - id: "2.5"
      title: "Crear Facturas Manualmente"
      status: "done"
      priority: "critical"
      dependencies: ["2.1", "2.3"]
      blocks: ["2.6", "2.7", "2.8", "2.9"]
      estimated_points: 5
      acceptance_criteria_count: 10
      notes: "Core invoice functionality - blocks state management"

    - id: "2.6"
      title: "Gestionar Estados de Facturas"
      status: "done"
      priority: "critical"
      dependencies: ["2.5"]
      blocks: ["2.2", "2.4", "2.7", "2.8", "2.9"]
      estimated_points: 5
      acceptance_criteria_count: 9
      notes: "State machine implementation - blocks parallel features"

    - id: "2.7"
      title: "Importar Facturas desde CSV"
      status: "done"
      priority: "medium"
      dependencies: ["2.1", "2.5", "2.6"]
      blocks: []
      estimated_points: 5
      acceptance_criteria_count: 8
      notes: "Can run in parallel with 2.2, 2.4, 2.9 after 2.6 is done"

    - id: "2.8"
      title: "Dashboard Básico con KPIs"
      status: "done"
      priority: "high"
      dependencies: ["2.1", "2.3", "2.5", "2.6"]
      blocks: []
      estimated_points: 5
      acceptance_criteria_count: 8
      notes: "COMPLETED 2025-12-03 - Dashboard with 4 KPIs, overdue chart, critical invoices table"

    - id: "2.9"
      title: "Exportar Datos a CSV"
      status: "done"
      priority: "high"
      dependencies: ["2.1", "2.3", "2.5"]
      blocks: []
      estimated_points: 3
      acceptance_criteria_count: 7
      notes: "COMPLETED 2025-12-03 - Client-side CSV export for companies, invoices, contacts. UTF-8 BOM for Excel compatibility."

  # ============================================================
  # RISK MITIGATION
  # ============================================================

  risk_mitigation:
    - risk: "Dependency chain could cause delays if stories fail"
      severity: "medium"
      mitigation: "Strict sequence enforcement - 2.1 → 2.3 → 2.5 → 2.6 → parallel features"
      status: "mitigated"

    - risk: "State machine complexity in 2.6 could introduce bugs"
      severity: "medium"
      mitigation: "Story 2.6 includes comprehensive state transition table and validation rules"
      status: "mitigated"

    - risk: "CSV import/export could have encoding issues with Spanish characters"
      severity: "low"
      mitigation: "Stories 2.7 and 2.9 specify UTF-8 with BOM for Excel compatibility"
      status: "mitigated"

    - risk: "Multi-tenancy could be bypassed if RLS not properly enforced"
      severity: "high"
      mitigation: "All stories enforce RLS at database level - tested in Story 1.1"
      status: "mitigated"

  # ============================================================
  # EXECUTION PLAN
  # ============================================================

  execution_plan:
    current_phase: "Phase 4 - Development COMPLETE"
    next_story: "epic-2-retrospective"
    current_story: null
    current_story_status: "all-stories-done"

    recommended_workflow:
      - step: 1
        action: "Dev agent executes Story 2.1"
        estimated_time: "5 hours"
        deliverables: ["Companies CRUD", "RLS policies", "UI pages", "Tests"]

      - step: 2
        action: "Code review Story 2.1"
        estimated_time: "1 hour"
        deliverables: ["Review feedback", "Fixes applied"]

      - step: 3
        action: "Mark 2.1 as DONE in sprint-status.yaml"
        estimated_time: "5 min"
        deliverables: ["Updated sprint status"]

      - step: 4
        action: "Dev agent executes Story 2.3"
        estimated_time: "5 hours"
        deliverables: ["Contacts CRUD", "RLS policies", "UI pages", "Tests"]

      - step: 5
        action: "Continue sequence: 2.5 → 2.6 → parallel (2.2, 2.4, 2.7, 2.9) → 2.8"
        estimated_time: "~30 hours total"
        deliverables: ["All Epic 2 functionality complete"]

      - step: 6
        action: "Execute Epic 2 retrospective"
        estimated_time: "1 hour"
        deliverables: ["Lessons learned", "Process improvements"]

  # ============================================================
  # VALIDATION CHECKLIST
  # ============================================================

  validation_checklist:
    epic_level:
      - item: "Epic 2 file exists and is complete"
        status: "✓"
      - item: "All functional requirements mapped to stories"
        status: "✓"
      - item: "FR11 (CSV export) clarified with PO"
        status: "✓"
      - item: "Business value clear for each story"
        status: "✓"
      - item: "MVP scope defined"
        status: "✓"

    story_level:
      - item: "All 9 stories have clear titles"
        status: "✓"
      - item: "All stories have acceptance criteria (6-10 AC each)"
        status: "✓"
      - item: "All stories have technical specifications"
        status: "✓"
      - item: "All stories have Definition of Done"
        status: "✓"
      - item: "Dependencies explicitly documented"
        status: "✓"
      - item: "No circular dependencies identified"
        status: "✓"

    technical_validation:
      - item: "Database schema defined for all entities"
        status: "✓"
      - item: "RLS policies specified for all tables"
        status: "✓"
      - item: "API routes documented"
        status: "✓"
      - item: "UI components specified"
        status: "✓"
      - item: "Form validations using Zod schemas"
        status: "✓"

    dependency_validation:
      - item: "Critical path identified: 2.1 → 2.3 → 2.5 → 2.6"
        status: "✓"
      - item: "Parallel work opportunities identified"
        status: "✓"
      - item: "No blocking issues"
        status: "✓"
      - item: "Sequence documented in this file"
        status: "✓"

  # ============================================================
  # PHASE 4 APPROVAL
  # ============================================================

  phase_4_approval:
    approved: true
    approved_by: "Scrum Master (Bob)"
    approved_date: "2025-12-02"

    approval_notes: |
      Epic 2 is READY for Phase 4 (Development).

      All prerequisites met:
      - 9 stories created and validated
      - Story 2.9 added per Product Owner decision (FR11)
      - Dependencies mapped and sequenced
      - Risks identified and mitigated
      - Implementation readiness report reviewed

      Dev agent can start with Story 2.1 immediately.

      Execution sequence: 2.1 → 2.3 → 2.5 → 2.6 → (2.2, 2.4, 2.7, 2.9) → 2.8

    next_steps:
      - "Dev agent: Execute Story 2.1 in next session"
      - "Follow strict sequencing to avoid blocking issues"
      - "Mark stories as DONE in sprint-status.yaml as completed"
      - "Run code review after each story"
      - "Execute retrospective when Epic 2 is complete"

# ============================================================
# SCHEMA REFINEMENT SPRINT (Between Epic 2 & Epic 3.4)
# ============================================================
# Generated: 2025-12-04
# Status: COMPLETED
# Purpose: Schema adjustments based on real-world usage feedback

schema_refinement_sprint:
  date: "2025-12-04"
  status: "completed"
  trigger: "User discovered field adjustments needed during real-world testing"

  changes_made:
    invoices:
      added_fields:
        - field: "payment_terms_days"
          type: "INTEGER DEFAULT 30"
          notes: "Moved from companies table - payment terms per invoice"
        - field: "projected_payment_date"
          type: "DATE NULL"
          notes: "Optional estimated payment date"
      ui_changes:
        - "Added paymentTermsDays input to invoice form"
        - "Added projectedPaymentDate date picker"
        - "Added paymentStatus selector at creation time"
        - "Added confirmedPaymentDate to creation form"
        - "Added 'Situación' column (Vencida/A tiempo) to invoice list"

    companies:
      added_fields:
        - field: "has_portal"
          type: "BOOLEAN DEFAULT false"
          notes: "Whether company uses payment portal"
      removed_fields:
        - field: "email"
          reason: "Email belongs to contacts, not companies"
        - field: "payment_terms_days"
          reason: "Moved to invoices table for per-invoice flexibility"
      ui_changes:
        - "Removed email field from company form"
        - "Removed paymentTermsDays field from company form"
        - "Added hasPortal toggle checkbox"
        - "Fixed invoice_count bug (was hardcoded to 0)"

    contacts:
      investigation:
        - issue: "Badges for Primary/Escalation contacts never appear"
        - finding: "Code exists correctly, likely data issue (values stored as false)"
        - status: "Requires production data verification"

  stories_completed:
    - id: "Story 0"
      title: "Investigar Bug Badges Contactos"
      status: "done (code OK, needs data verification)"

    - id: "Story A"
      title: "Migración de Schema"
      status: "done"
      files_modified:
        - "prisma/schema.prisma"
        - "src/lib/validations/company-schema.ts"
        - "src/lib/validations/invoice-schema.ts"
        - "src/lib/services/company-service.ts"
        - "src/lib/services/invoice-service.ts"

    - id: "Story B"
      title: "UI de Facturas"
      status: "done"
      files_modified:
        - "src/components/forms/invoice-form.tsx"
        - "src/app/(dashboard)/invoices/page.tsx"

    - id: "Story C"
      title: "UI de Empresas + Fix Bugs"
      status: "done"
      files_modified:
        - "src/components/forms/company-form.tsx"
        - "src/app/(dashboard)/companies/[companyId]/edit/page.tsx"

    - id: "Story D"
      title: "Actualizar Documentación"
      status: "done"
      files_modified:
        - "docs/sprint-artifacts/sprint-status.yaml"

  sql_migration:
    file: "prisma/migrations/manual-refinamiento-schema.sql"
    status: "pending - must be run manually in Supabase"
    commands: |
      -- Run in Supabase SQL Editor:
      ALTER TABLE companies ADD COLUMN IF NOT EXISTS has_portal BOOLEAN DEFAULT false;
      ALTER TABLE invoices ADD COLUMN IF NOT EXISTS payment_terms_days INTEGER DEFAULT 30;
      ALTER TABLE invoices ADD COLUMN IF NOT EXISTS projected_payment_date DATE;
      ALTER TABLE companies DROP COLUMN IF EXISTS email;
      ALTER TABLE companies DROP COLUMN IF EXISTS payment_terms_days;

  next_step: "Continue with Story 3.4 (Schema de Collections)"

# ============================================================
# EPIC 3 DETAILED SPRINT PLANNING
# ============================================================
# Generated: 2025-12-03
# Party Mode Session: Completed with PM, Architect, SM, TEA
# Status: Ready for Phase 4 (Development)
# Total Stories: 7

epic_3_detailed_plan:
  epic_id: "epic-3"
  epic_name: "Motor de Cobranzas Automatizado"
  phase: "Phase 4 - Implementation IN PROGRESS"
  status: "in-progress"
  total_stories: 7
  completed_stories: 3

  # ============================================================
  # PARTY MODE DECISIONS (2025-12-03)
  # ============================================================
  party_mode_decisions:
    gap_c1_messaging:
      problem: "Story 3.6 requires sendEmail/sendWhatsApp but not in Epic 3"
      resolution: "IMessageService interface + MockMessageService in Epic 3"
      implementation: "Real SendGridService + TwilioService in Epic 4"
      owner: "Winston (Architect)"

    gap_c2_state_machine:
      problem: "Collection state transitions not documented"
      resolution: "Full state machine with 6 states and 11 allowed transitions"
      states: ["active", "paused", "awaiting_response", "pending_review", "completed", "escalated"]
      terminal_state: "completed"
      owner: "Bob (SM)"

    gap_c3_rate_limiting:
      problem: "Rate limit scope was ambiguous"
      resolution: |
        - maxActiveCollectionsPerTenant: 5 (per tenant)
        - minHoursBetweenMessagesToSameContact: 4 (per contact)
        - maxMessagesPerDayPerTenant: 10 (per tenant)
      owner: "Winston (Architect)"

    risk_r001_race_condition:
      problem: "Worker race condition could cause duplicate messages"
      severity: 9
      resolution: "Upstash Redis distributed lock with 45 second TTL"
      owner: "Murat (TEA)"

  # ============================================================
  # CRITICAL STORY SEQUENCE
  # ============================================================
  # Stories MUST be executed in this order to respect dependencies

  story_sequence:
    schema_layer:
      # MUST execute first - creates Playbook and PlaybookMessage tables
      - "3.1"
      # Creates Collection table (can run parallel with 3.1)
      - "3.4"

    builder_layer:
      # Depends on 3.1 (Playbook schema must exist)
      - "3.2"

    seed_layer:
      # Depends on 3.2 (builder patterns useful for seed)
      - "3.3"

    collection_flow:
      # Depends on 3.4 (Collection schema) + 3.3 (default playbooks)
      - "3.5"

    automation_layer:
      # Depends on 3.5 (collections must exist to process)
      # CRITICAL: Requires Upstash Redis setup BEFORE implementation
      - "3.6"

    control_layer:
      # Depends on 3.5 (collections exist) + 3.6 (worker context)
      - "3.7"

  # ============================================================
  # STORY DETAILS
  # ============================================================

  stories:
    - id: "3.1"
      title: "Schema de Playbooks y Mensajes"
      status: "done"
      priority: "critical"
      dependencies: ["epic-2-complete"]
      blocks: ["3.2", "3.3"]
      estimated_points: 3
      acceptance_criteria_count: 4
      completed_date: "2025-12-03"
      notes: "COMPLETED - Prisma schema + RLS policies + partial unique index + integration tests"

    - id: "3.2"
      title: "Builder de Playbooks"
      status: "backlog"
      priority: "high"
      dependencies: ["3.1"]
      blocks: ["3.3"]
      estimated_points: 8
      acceptance_criteria_count: 6
      notes: "Complex UI with @dnd-kit drag & drop"

    - id: "3.3"
      title: "Playbooks Pre-configurados (Seed)"
      status: "done"
      priority: "medium"
      dependencies: ["3.2"]
      blocks: ["3.5"]
      estimated_points: 3
      acceptance_criteria_count: 3
      completed_date: "2025-12-03"
      notes: "COMPLETED - 3 default playbooks in Spanish, integrated with tenant provisioning"

    - id: "3.4"
      title: "Schema de Collections"
      status: "backlog"
      priority: "critical"
      dependencies: ["epic-2-complete"]
      blocks: ["3.5", "3.6", "3.7"]
      estimated_points: 3
      acceptance_criteria_count: 4
      notes: "Can run parallel with 3.1"

    - id: "3.5"
      title: "Crear Cobranza desde Factura"
      status: "backlog"
      priority: "high"
      dependencies: ["3.3", "3.4"]
      blocks: ["3.6", "3.7"]
      estimated_points: 5
      acceptance_criteria_count: 5
      notes: "Modal + API for creating collections"

    - id: "3.6"
      title: "Worker de Procesamiento Automático"
      status: "backlog"
      priority: "critical"
      dependencies: ["3.5"]
      blocks: ["3.7"]
      estimated_points: 8
      acceptance_criteria_count: 11
      notes: "CRITICAL: Setup Upstash BEFORE implementing. Uses MockMessageService."
      prerequisites:
        - "Upstash account configured"
        - "UPSTASH_REDIS_REST_URL env var"
        - "UPSTASH_REDIS_REST_TOKEN env var"

    - id: "3.7"
      title: "Control Manual de Cobranzas"
      status: "backlog"
      priority: "high"
      dependencies: ["3.5"]
      blocks: []
      estimated_points: 5
      acceptance_criteria_count: 5
      notes: "Pause/Resume/Complete + Timeline UI"

  # ============================================================
  # TECHNICAL PREREQUISITES
  # ============================================================

  technical_prerequisites:
    npm_packages:
      - package: "@dnd-kit/core"
        version: "^6.0.0"
        story: "3.2"
      - package: "@dnd-kit/sortable"
        version: "^7.0.0"
        story: "3.2"
      - package: "@upstash/redis"
        version: "^1.28.0"
        story: "3.6"

    environment_variables:
      - name: "UPSTASH_REDIS_REST_URL"
        story: "3.6"
        required: true
      - name: "UPSTASH_REDIS_REST_TOKEN"
        story: "3.6"
        required: true

    vercel_config:
      - type: "cron"
        path: "/api/cron/collection-worker"
        schedule: "*/5 * * * *"
        story: "3.6"

  # ============================================================
  # RISK MITIGATION
  # ============================================================

  risk_mitigation:
    - risk: "R-001: Worker race condition causes duplicate messages"
      severity: "critical"
      mitigation: "Upstash Redis distributed lock with TTL 45s"
      status: "designed"
      owner: "Murat (TEA)"

    - risk: "R-002: RLS misconfiguration on new tables"
      severity: "high"
      mitigation: "Pre-deploy RLS validation script"
      status: "pending"
      owner: "Winston (Architect)"

    - risk: "Drag & drop complexity in Playbook Builder"
      severity: "medium"
      mitigation: "Use proven @dnd-kit library, follow existing patterns"
      status: "planned"

    - risk: "Template variable replacement errors"
      severity: "low"
      mitigation: "Graceful handling - undefined vars replaced with empty string"
      status: "designed"

  # ============================================================
  # EXECUTION PLAN
  # ============================================================

  execution_plan:
    current_phase: "Phase 4 - Development IN PROGRESS"
    next_story: "3.4"
    current_story: null
    current_story_status: "3.1 completed, 3.4 ready"

    recommended_workflow:
      - step: 1
        action: "Setup Upstash Redis account"
        estimated_time: "30 min"
        deliverables: ["Upstash account", "Redis database created"]
        blocking: true

      - step: 2
        action: "Add UPSTASH env vars to Vercel"
        estimated_time: "10 min"
        deliverables: ["Environment variables configured"]
        blocking: true

      - step: 3
        action: "Install npm packages (@dnd-kit, @upstash/redis)"
        estimated_time: "10 min"
        deliverables: ["Dependencies installed"]
        blocking: true

      - step: 4
        action: "Dev agent executes Story 3.1 (Playbook Schema)"
        estimated_time: "3 hours"
        deliverables: ["Prisma migration", "RLS policies", "Tests"]

      - step: 5
        action: "Dev agent executes Story 3.4 (Collection Schema) - parallel if capacity"
        estimated_time: "3 hours"
        deliverables: ["Prisma migration", "RLS policies", "Conditional UNIQUE index"]

      - step: 6
        action: "Dev agent executes Story 3.2 (Playbook Builder)"
        estimated_time: "8 hours"
        deliverables: ["UI pages", "Drag & drop", "Template preview"]

      - step: 7
        action: "Continue sequence: 3.3 → 3.5 → 3.6 → 3.7"
        estimated_time: "~21 hours total"
        deliverables: ["All Epic 3 functionality complete"]

      - step: 8
        action: "Execute Epic 3 retrospective"
        estimated_time: "1 hour"
        deliverables: ["Lessons learned", "Process improvements"]

  # ============================================================
  # PHASE 4 APPROVAL
  # ============================================================

  phase_4_approval:
    approved: true
    approved_by: "Scrum Master (Bob) - Party Mode Session"
    approved_date: "2025-12-03"

    approval_notes: |
      Epic 3 is READY for Phase 4 (Development).

      Party Mode Session completed with:
      - PM (John): Validated PRD alignment
      - Architect (Winston): Resolved C1, C3, designed IMessageService
      - SM (Bob): Documented State Machine (C2)
      - TEA (Murat): Designed R-001 mitigation with Upstash

      All prerequisites met:
      - 7 stories validated and enhanced
      - Gaps C1, C2, C3 resolved and documented in epic-3-motor-cobranzas.md
      - Risk R-001 mitigated with Upstash design
      - Dependencies mapped and sequenced

      BEFORE starting development:
      1. Setup Upstash Redis account
      2. Configure env vars in Vercel
      3. Install @dnd-kit and @upstash/redis packages

      Dev agent can start with Story 3.1 after prerequisites are complete.

      Execution sequence: 3.1 + 3.4 (parallel) → 3.2 → 3.3 → 3.5 → 3.6 → 3.7

    next_steps:
      - "Setup: Create Upstash Redis account and configure env vars"
      - "Setup: Install @dnd-kit/core, @dnd-kit/sortable, @upstash/redis"
      - "Dev agent: Execute Story 3.1 (Playbook Schema)"
      - "Follow strict sequencing to avoid blocking issues"
      - "Mark stories as DONE in sprint-status.yaml as completed"
      - "Run code review after each story"
      - "Execute retrospective when Epic 3 is complete"
